<html lang="en">
	<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

		<link href="../CSS/bootstrap.css" rel="stylesheet">
        <link href="../CSS/organize.css" rel="stylesheet">

        <link href="../CSS/font.css" rel="stylesheet">

        <title>Stove Sensor</title>

        <link rel="icon" href="../Images/icon.png">

        <script src="../js/XHRequest.js"></script>
        <script>

        var codeSet = false;

        function checkIfCodeSet() {
            XHRequest.createRequest({
                success: setCodeStatus,
                params: {
                    command: "load_setup",
                },
                url: "../scripts/ajax.py"
            });
        }

        function setCodeStatus(xhr, xhrConfig) {
            console.log("setting up page");
            var response = JSON.parse(xhr.responseText);
            codeSet = response.code_set
            if (response.numbers != null && response.numbers.length != 0) {
                console.log("Updated numbers");
                document.getElementById("numbers").value = response.numbers;
            }
        }

        function submitInfo() {
            var numbers = document.getElementById("numbers").value;
            numbers_arr = parseNumbers(numbers);
            if (!codeSet) {
                generateCode();
            }
            if (numbers_arr != null) {
                uploadData(numbers_arr);
            }
        }

        function parseNumbers(phone_numbers) {
            console.log(phone_numbers);
            var arr = phone_numbers.split(',');
            var completed = true;
            for (var i = 0; i < arr.length; i++) {
                arr[i] = arr[i].replace(" ", "");
                if (arr[i].length != 12 || arr[i].indexOf("+") < 0) {
                    alert("There was an error with one of the phone numbers. Please make sure they are valid and follow the +1XXXXXXXXXX format.");
                    completed = false;
                }
                arr[i] = arr[i].replace("+", encodeURIComponent("+"));
            }
            if (completed) {
                return arr;
            }
            else {
                return null;
            }
            console.log(arr);
        }

        function uploadData(phone_numbers) {
            numbers = JSON.stringify(phone_numbers);
            XHRequest.createRequest({
                success: confirmUpload,
                params: {
                    command: "initial_setup",
                    phone: numbers
                },
                url: "../scripts/ajax.py"
            });
        }

        function generateCode() {
            XHRequest.createRequest({
                success: saveCode,
                params: {
                    command: "newdevice",
                },
                url: "https://www.iotspace.tech/stovesensor/scripts/data_storage.py"
            });
        }

        function saveCode(xhr, xhrConfig) {
            var response = JSON.parse(xhr.responseText);
            console.log(response);
            var completed = response.success;
            var code = response.new_code;
            XHRequest.createRequest({
                success: confirmUpload,
                params: {
                    command: "set_code",
                    code: code
                },
                url: "../scripts/ajax.py"
            });
        }

        function confirmUpload() {

        }
            
        </script>
	</head>

	<body onload="checkIfCodeSet()">
        <img src="../Images/background.png" class="background">
        <p class="title text-center" id="header">Stove <b class="red">Sensor</b></p>
        
        <h1 class="title text-center">Welcome to StoveSensor.</h1>
        <h3 class="special-font text-center">Please enter the following information to get started.</h3>

        <form class="container-fluid">
            <p>If your stove is ever left on, stovesensor will text you with alerts. For this feature, please enter the phone numbers you would like this alert to be sent to in the format +1XXXXXXXXXX with no parantheses or dashes. Seperate each phone number with a comma and include country code for each number. <br>Note: messaging fees may apply.</p>
            <div class="form-group">
                <label>Phone Numbers</label>
                <input class="form-control" placeholder="Phone" id="numbers" value="+1">
            </div>
        </form>

        <button class="btn btn-primary" onclick="submitInfo()">Submit</button>

	</body>
</html>